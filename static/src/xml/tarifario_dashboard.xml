<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="logistica_tarifario.DashboardMain">
        <div class="o_action tarifario-dashboard">
            <!-- Loader -->
            <div t-if="state.loading" class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
                <div class="spinner-border text-primary" role="status"></div>
            </div>

            <!-- Main Content -->
            <div t-if="!state.loading" class="container-fluid">
                
                <!-- Header Moderno -->
                <div class="dashboard-header d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="fw-bold text-dark mb-1">Logística Global</h2>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item text-primary">Intelligence Hub</li>
                                <li class="breadcrumb-item active">Tarifario v1.1</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-white shadow-sm border" t-on-click="refresh">
                            <i class="fa fa-refresh me-2 text-primary"/>Sincronizar
                        </button>
                        <button class="btn btn-primary shadow-sm" t-on-click="openAllTarifas">
                            <i class="fa fa-plus me-2"/>Ver Todo
                        </button>
                    </div>
                </div>

                <!-- KPIs Principales -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="card kpi-card p-3" t-on-click="openTarifasActivas" style="cursor:pointer;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <p class="card-title-custom mb-1">Fletes Vigentes</p>
                                    <h2 class="stat-value mb-0"><t t-esc="resumen.activas"/></h2>
                                </div>
                                <div class="icon-box bg-soft-success">
                                    <i class="fa fa-check-circle fa-2x text-success"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card kpi-card p-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <p class="card-title-custom mb-1">Promedio All In</p>
                                    <h2 class="stat-value mb-0 text-primary">$<t t-esc="promedios.all_in"/></h2>
                                </div>
                                <div class="icon-box bg-soft-primary">
                                    <i class="fa fa-dollar fa-2x text-primary"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card kpi-card p-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <p class="card-title-custom mb-1">Tiempo de Tránsito</p>
                                    <h2 class="stat-value mb-0 text-info"><t t-esc="promedios.transit_time"/> <small style="font-size: 1rem">días</small></h2>
                                </div>
                                <div class="icon-box bg-soft-info">
                                    <i class="fa fa-ship fa-2x text-info"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card kpi-card p-3" t-on-click="openTarifasExpiradas" style="cursor:pointer;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <p class="card-title-custom mb-1">Tarifas Vencidas</p>
                                    <h2 class="stat-value mb-0 text-danger"><t t-esc="resumen.expiradas"/></h2>
                                </div>
                                <div class="icon-box" style="background: #fee2e2;">
                                    <i class="fa fa-exclamation-triangle fa-2x text-danger"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Segunda Fila: Tablas y Rankings -->
                <div class="row g-4 mb-4">
                    <!-- Top Forwarders -->
                    <div class="col-lg-8">
                        <div class="card shadow-sm border-0 rounded-4">
                            <div class="card-header bg-white py-3 border-0">
                                <h5 class="fw-bold mb-0 text-dark">Rendimiento de Forwarders</h5>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-custom mb-0">
                                    <thead>
                                        <tr>
                                            <th>Proveedor</th>
                                            <th class="text-center">Tarifas</th>
                                            <th class="text-end">Avg. All In</th>
                                            <th class="text-end">Avg. Transit</th>
                                            <th class="text-end">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="topForwarders" t-as="f" t-key="f.id">
                                            <tr>
                                                <td class="fw-bold text-dark"><t t-esc="f.name"/></td>
                                                <td class="text-center"><span class="badge rounded-pill bg-light text-dark border"><t t-esc="f.count"/></span></td>
                                                <td class="text-end text-primary fw-bold">$<t t-esc="f.avg_all_in"/></td>
                                                <td class="text-end"><t t-esc="f.avg_transit"/> d</td>
                                                <td class="text-end">
                                                    <button class="btn btn-sm btn-light" t-on-click="() => this.openByForwarder(f.id)">
                                                        <i class="fa fa-eye"/>
                                                    </button>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Top Rutas -->
                    <div class="col-lg-4">
                        <div class="card shadow-sm border-0 rounded-4 h-100">
                            <div class="card-header bg-white py-3 border-0">
                                <h5 class="fw-bold mb-0 text-dark">Rutas Frecuentes</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush">
                                    <t t-foreach="topRutas" t-as="r" t-key="r_index">
                                        <div class="list-group-item border-0 px-4 py-3" t-on-click="() => this.openByRuta(r.pol_id, r.pod_id)" style="cursor:pointer">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="fw-bold text-dark small text-truncate"><t t-esc="r.ruta"/></span>
                                                <span class="badge bg-soft-primary"><t t-esc="r.count"/> cot.</span>
                                            </div>
                                            <div class="d-flex justify-content-between small">
                                                <span class="text-muted"><i class="fa fa-clock-o me-1"/> <t t-esc="r.avg_transit"/> días</span>
                                                <span class="text-success fw-bold">$<t t-esc="r.avg_all_in"/></span>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tercera Fila: Equipos -->
                <div class="row g-4 mb-5">
                    <div class="col-12">
                        <div class="card shadow-sm border-0 rounded-4">
                            <div class="card-header bg-white py-3 border-0 d-flex justify-content-between">
                                <h5 class="fw-bold mb-0">Costos por Tipo de Equipo</h5>
                                <span class="text-muted small">Promedios Globales</span>
                            </div>
                            <div class="card-body pb-4">
                                <div class="row g-3">
                                    <t t-foreach="porEquipo" t-as="e" t-key="e.equipo">
                                        <div class="col-md-2">
                                            <div class="p-3 border rounded-3 text-center bg-light" t-on-click="() => this.openByEquipo(e.equipo)" style="cursor:pointer">
                                                <div class="text-muted x-small text-uppercase mb-1"><t t-esc="e.equipo_label"/></div>
                                                <div class="fw-bold text-dark h5 mb-0">$<t t-esc="e.avg_all_in"/></div>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </t>
</templates>