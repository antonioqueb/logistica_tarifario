<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="logistica_tarifario.DashboardMain">
        <div class="o_action tarifario-dashboard">
            <!-- Loading State -->
            <div t-if="state.loading" class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
                <div class="text-center">
                    <i class="fa fa-spinner fa-spin fa-3x text-primary mb-3"/>
                    <p class="text-muted">Cargando indicadores...</p>
                </div>
            </div>

            <!-- Error State -->
            <div t-if="state.error and !state.loading" class="alert alert-danger m-4">
                <i class="fa fa-exclamation-triangle me-2"/>
                Error: <t t-esc="state.error"/>
                <button class="btn btn-sm btn-outline-danger ms-3" t-on-click="refresh">Reintentar</button>
            </div>

            <!-- Dashboard Content -->
            <div t-if="!state.loading and !state.error" class="p-4">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1 fw-bold text-dark">
                            <i class="fa fa-ship text-primary me-2"/>
                            Panel de Control - Tarifario Logístico
                        </h2>
                        <p class="text-muted mb-0">Indicadores de gestión para el departamento de importaciones</p>
                    </div>
                    <button class="btn btn-outline-primary" t-on-click="refresh">
                        <i class="fa fa-refresh me-1"/> Actualizar
                    </button>
                </div>

                <!-- Alertas -->
                <div t-if="alertas.length > 0" class="mb-4">
                    <t t-foreach="alertas" t-as="alerta" t-key="alerta_index">
                        <div t-attf-class="alert alert-#{alerta.tipo} d-flex align-items-center mb-2" role="alert">
                            <i t-attf-class="fa #{alerta.icono} me-2"/>
                            <span><t t-esc="alerta.mensaje"/></span>
                        </div>
                    </t>
                </div>

                <!-- KPIs Principales (4 cards) -->
                <div class="row g-3 mb-4">
                    <!-- Total Tarifas -->
                    <div class="col-md-3">
                        <div class="card h-100 border-0 shadow-sm" style="cursor: pointer;" t-on-click="openAllTarifas">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted text-uppercase small mb-1">Total Tarifas</p>
                                        <h3 class="fw-bold mb-0 text-dark"><t t-esc="resumen.total || 0"/></h3>
                                    </div>
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-3 d-flex align-items-center">
                                        <i class="fa fa-database fa-lg text-primary"/>
                                    </div>
                                </div>
                                <small class="text-muted"><i class="fa fa-mouse-pointer me-1"/>Click para ver todas</small>
                            </div>
                        </div>
                    </div>

                    <!-- Tarifas Activas -->
                    <div class="col-md-3">
                        <div class="card h-100 border-0 shadow-sm" style="cursor: pointer;" t-on-click="openTarifasActivas">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted text-uppercase small mb-1">Tarifas Vigentes</p>
                                        <h3 class="fw-bold mb-0 text-success"><t t-esc="resumen.activas || 0"/></h3>
                                    </div>
                                    <div class="bg-success bg-opacity-10 rounded-circle p-3 d-flex align-items-center">
                                        <i class="fa fa-check-circle fa-lg text-success"/>
                                    </div>
                                </div>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-success" 
                                         t-attf-style="width: #{resumen.total > 0 ? (resumen.activas / resumen.total * 100) : 0}%"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tarifas Expiradas -->
                    <div class="col-md-3">
                        <div class="card h-100 border-0 shadow-sm" style="cursor: pointer;" t-on-click="openTarifasExpiradas">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-muted text-uppercase small mb-1">Tarifas Expiradas</p>
                                        <h3 class="fw-bold mb-0 text-danger"><t t-esc="resumen.expiradas || 0"/></h3>
                                    </div>
                                    <div class="bg-danger bg-opacity-10 rounded-circle p-3 d-flex align-items-center">
                                        <i class="fa fa-clock-o fa-lg text-danger"/>
                                    </div>
                                </div>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-danger" 
                                         t-attf-style="width: #{resumen.total > 0 ? (resumen.expiradas / resumen.total * 100) : 0}%"/>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Promedio ALL IN con variación -->
                    <div class="col-md-3">
                        <div class="card h-100 border-0 shadow-sm bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <p class="text-white-50 text-uppercase small mb-1">Promedio ALL IN</p>
                                        <h3 class="fw-bold mb-0">$<t t-esc="promedios.all_in || 0"/></h3>
                                    </div>
                                    <div class="bg-white bg-opacity-25 rounded-circle p-3 d-flex align-items-center">
                                        <i class="fa fa-dollar fa-lg"/>
                                    </div>
                                </div>
                                <small class="d-flex align-items-center mt-1">
                                    <i t-attf-class="fa #{variaciones.variacion_all_in > 0 ? 'fa-arrow-up' : variaciones.variacion_all_in &lt; 0 ? 'fa-arrow-down' : 'fa-minus'} me-1"/>
                                    <span><t t-esc="variaciones.variacion_all_in || 0"/>% vs mes anterior</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Segunda fila: Costos y Tiempos -->
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center py-3">
                                <i class="fa fa-anchor fa-2x text-info mb-2"/>
                                <p class="text-muted small mb-1">Ocean Freight</p>
                                <h5 class="fw-bold text-info mb-0">$<t t-esc="promedios.ocean_freight || 0"/></h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center py-3">
                                <i class="fa fa-file-text-o fa-2x text-warning mb-2"/>
                                <p class="text-muted small mb-1">AMS + IMO</p>
                                <h5 class="fw-bold text-warning mb-0">$<t t-esc="promedios.ams_imo || 0"/></h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center py-3">
                                <i class="fa fa-shield fa-2x text-secondary mb-2"/>
                                <p class="text-muted small mb-1">Lib + Seguro</p>
                                <h5 class="fw-bold text-secondary mb-0">$<t t-esc="promedios.lib_seguro || 0"/></h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center py-3">
                                <i class="fa fa-calendar fa-2x mb-2" style="color: #6f42c1;"/>
                                <p class="text-muted small mb-1">Transit Time</p>
                                <h5 class="fw-bold mb-0" style="color: #6f42c1;"><t t-esc="promedios.transit_time || 0"/> días</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center py-3">
                                <i class="fa fa-hourglass-half fa-2x text-danger mb-2"/>
                                <p class="text-muted small mb-1">Free Time</p>
                                <h5 class="fw-bold text-danger mb-0"><t t-esc="promedios.demoras || 0"/> días</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body text-center py-3">
                                <i class="fa fa-percent fa-2x text-success mb-2"/>
                                <p class="text-muted small mb-1">% Extras/Ocean</p>
                                <h5 class="fw-bold text-success mb-0"><t t-esc="promedios.margen_pct || 0"/>%</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tercera fila: Rankings -->
                <div class="row g-3 mb-4">
                    <!-- Top Forwarders -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0"><i class="fa fa-truck text-primary me-2"/>Top Forwarders</h6>
                            </div>
                            <div class="card-body pt-2">
                                <t t-if="topForwarders.length === 0">
                                    <p class="text-muted text-center small">Sin datos</p>
                                </t>
                                <div t-else="" class="list-group list-group-flush">
                                    <t t-foreach="topForwarders" t-as="f" t-key="f.id">
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center px-0 border-0"
                                           t-on-click.prevent="() => this.openByForwarder(f.id)">
                                            <div>
                                                <span class="badge bg-primary bg-opacity-10 text-primary me-2"><t t-esc="f_index + 1"/></span>
                                                <span class="small"><t t-esc="f.name"/></span>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-light text-dark"><t t-esc="f.count"/></span>
                                                <small class="text-success d-block">$<t t-esc="f.avg_all_in"/></small>
                                            </div>
                                        </a>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Navieras -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0"><i class="fa fa-ship text-info me-2"/>Top Navieras</h6>
                            </div>
                            <div class="card-body pt-2">
                                <t t-if="topNavieras.length === 0">
                                    <p class="text-muted text-center small">Sin datos</p>
                                </t>
                                <div t-else="" class="list-group list-group-flush">
                                    <t t-foreach="topNavieras" t-as="n" t-key="n.id">
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center px-0 border-0"
                                           t-on-click.prevent="() => this.openByNaviera(n.id)">
                                            <div>
                                                <span class="badge bg-info bg-opacity-10 text-info me-2"><t t-esc="n_index + 1"/></span>
                                                <span class="small"><t t-esc="n.name"/></span>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-light text-dark"><t t-esc="n.count"/></span>
                                                <small class="text-success d-block">$<t t-esc="n.avg_all_in"/></small>
                                            </div>
                                        </a>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Rutas -->
                    <div class="col-md-4">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0"><i class="fa fa-map-marker text-success me-2"/>Top Rutas</h6>
                            </div>
                            <div class="card-body pt-2">
                                <t t-if="topRutas.length === 0">
                                    <p class="text-muted text-center small">Sin datos</p>
                                </t>
                                <div t-else="" class="list-group list-group-flush">
                                    <t t-foreach="topRutas" t-as="r" t-key="r_index">
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center px-0 border-0"
                                           t-on-click.prevent="() => this.openByRuta(r.pol_id, r.pod_id)">
                                            <div>
                                                <span class="small text-truncate" style="max-width: 180px;">
                                                    <t t-esc="r.ruta"/>
                                                </span>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-success bg-opacity-10 text-success"><t t-esc="r.count"/></span>
                                                <small class="text-muted d-block"><t t-esc="r.avg_transit"/>d</small>
                                            </div>
                                        </a>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cuarta fila: Equipos y Países -->
                <div class="row g-3 mb-4">
                    <!-- Por Equipo -->
                    <div class="col-md-7">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0"><i class="fa fa-cube text-warning me-2"/>Tarifas por Tipo de Equipo</h6>
                            </div>
                            <div class="card-body pt-2">
                                <t t-if="porEquipo.length === 0">
                                    <p class="text-muted text-center">Sin datos de equipos</p>
                                </t>
                                <div t-else="" class="row g-2">
                                    <t t-foreach="porEquipo" t-as="e" t-key="e.equipo">
                                        <div class="col-6 col-md-4 col-lg-3">
                                            <div class="border rounded p-2 text-center bg-light h-100" style="cursor: pointer;"
                                                 t-on-click="() => this.openByEquipo(e.equipo)">
                                                <p class="fw-bold mb-0 text-dark small"><t t-esc="e.equipo_label"/></p>
                                                <small class="text-muted d-block"><t t-esc="e.count"/> tarifas</small>
                                                <small class="text-success fw-bold">$<t t-esc="e.avg_all_in"/></small>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Por País -->
                    <div class="col-md-5">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0"><i class="fa fa-globe text-danger me-2"/>Tarifas por País</h6>
                            </div>
                            <div class="card-body pt-2">
                                <t t-if="porPais.length === 0">
                                    <p class="text-muted text-center">Sin datos de países</p>
                                </t>
                                <t t-else="">
                                    <t t-foreach="porPais" t-as="c" t-key="c.country_id">
                                        <div class="mb-2" style="cursor: pointer;" t-on-click="() => this.openByPais(c.country_id)">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="small"><i class="fa fa-flag-o me-2 text-muted"/><t t-esc="c.country_name"/></span>
                                                <div>
                                                    <span class="badge bg-secondary me-1"><t t-esc="c.count"/></span>
                                                    <span class="badge bg-success">$<t t-esc="c.avg_all_in"/></span>
                                                </div>
                                            </div>
                                            <div class="progress" style="height: 4px;">
                                                <div class="progress-bar bg-danger bg-opacity-75" 
                                                     t-attf-style="width: #{porPais[0] ? (c.count / porPais[0].count * 100) : 0}%"/>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quinta fila: Comparativo de Equipos -->
                <div t-if="comparativoEquipos.length > 0" class="row g-3 mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0">
                                <h6 class="fw-bold mb-0"><i class="fa fa-bar-chart text-primary me-2"/>Comparativo de Costos por Equipo (Min / Prom / Max)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <t t-foreach="comparativoEquipos" t-as="eq" t-key="eq.equipo">
                                        <div class="col-md-4 col-lg-2">
                                            <div class="border rounded p-3 text-center">
                                                <h6 class="fw-bold text-primary mb-2"><t t-esc="eq.label"/></h6>
                                                <div class="d-flex justify-content-between small">
                                                    <span class="text-success">$<t t-esc="eq.min"/></span>
                                                    <span class="fw-bold">$<t t-esc="eq.avg"/></span>
                                                    <span class="text-danger">$<t t-esc="eq.max"/></span>
                                                </div>
                                                <small class="text-muted"><t t-esc="eq.count"/> tarifas</small>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sexta fila: Tendencia Mensual -->
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 pb-0 d-flex justify-content-between align-items-center">
                                <h6 class="fw-bold mb-0"><i class="fa fa-line-chart text-primary me-2"/>Tendencia de Tarifas (Últimos 12 periodos)</h6>
                                <t t-if="variaciones.tendencia">
                                    <span t-attf-class="badge #{variaciones.tendencia === 'alza' ? 'bg-danger' : variaciones.tendencia === 'baja' ? 'bg-success' : 'bg-warning'}">
                                        Tendencia: <t t-esc="variaciones.tendencia"/>
                                    </span>
                                </t>
                            </div>
                            <div class="card-body">
                                <t t-if="tendencia.length === 0">
                                    <p class="text-muted text-center">Sin datos históricos</p>
                                </t>
                                <div t-else="" class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Periodo</th>
                                                <th class="text-center">Cantidad</th>
                                                <th class="text-end">Prom. Ocean</th>
                                                <th class="text-end">Prom. ALL IN</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="tendencia" t-as="t" t-key="t.periodo">
                                                <tr>
                                                    <td><span class="badge bg-light text-dark"><t t-esc="t.periodo"/></span></td>
                                                    <td class="text-center"><t t-esc="t.count"/></td>
                                                    <td class="text-end text-info">$<t t-esc="t.avg_ocean"/></td>
                                                    <td class="text-end fw-bold text-success">$<t t-esc="t.avg_all_in"/></td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </t>
</templates>